---
title: "Homework 6"
author: "Ayeshra Acharya"
date: "11/24/2020"
output: github_document
---
```{r setup, include=FALSE}
knitr::opts_chunk$set(
	echo = TRUE,
	warning = FALSE,
	fig.width = 8, 
  fig.height = 6,
  out.width = "90%"
)
options(
  ggplot2.continuous.colour = "viridis",
  ggplot2.continuous.fill = "viridis"
)
scale_colour_discrete = scale_colour_viridis_d
scale_fill_discrete = scale_fill_viridis_d
theme_set(theme_minimal() + theme(legend.position = "bottom"))
```

```{r}
library(tidyverse)
library(p8105.datasets)
library(modelr)
```

## Problem 1 

```{r, message = FALSE}
homicide_df = 
  read_csv("data/homicide-data.csv", na = c("", "NA", "Unknown")) %>% 
  mutate(
    city_state = str_c(city, state, sep = ", "),
    victim_age = as.numeric(victim_age),
    resolution = case_when(
      disposition == "Closed without arrest" ~ 0,
      disposition == "Open/No arrest"        ~ 0,
      disposition == "Closed by arrest"      ~ 1)
  ) %>% 
  filter(
    victim_race %in% c("White", "Black"),
    city_state != "Tulsa, AL") %>% 
  select(city_state, resolution, victim_age, victim_race, victim_sex)
```


Start with one city. 
```{r}
baltimore_df =
  homicide_df %>% 
  filter(city_state == "Baltimore, MD")
glm(resolution ~ victim_age + victim_race + victim_sex, 
    data = baltimore_df,
    family = binomial()) %>% 
  broom::tidy() %>% 
  mutate(
    OR = exp(estimate),
    CI_lower = exp(estimate - 1.96 * std.error),
    CI_upper = exp(estimate + 1.96 * std.error)
  ) %>% 
  select(term, OR, starts_with("CI")) %>% 
  knitr::kable(digits = 3)
``` 
Want to do same process for every city in dataset. How? 
First, nest dataset and then map over that fitting the regression model and then map across regression model. 
We want city estimates of OR and estimates comparing age, race and sex. 

```{r}
models_results_df = 
  homicide_df %>% 
  nest(data = -city_state) %>% 
  mutate(
    models = 
      map(.x = data, ~glm(resolution ~ victim_age + victim_race + victim_sex, data = .x, family = binomial())),
    results = map(models, broom::tidy)
  ) %>% 
  select(city_state, results) %>% 
  unnest(results) %>% 
  mutate(
    OR = exp(estimate),
    CI_lower = exp(estimate - 1.96 * std.error),
    CI_upper = exp(estimate + 1.96 * std.error)
  ) %>% 
  select(city_state, term, OR, starts_with("CI")) 
```
Make a plot of these OR comparing male homicide victims to female homicide victims. 
```{r}
models_results_df %>% 
  filter(term == "victim_sexMale") %>% 
  mutate(city_state = fct_reorder(city_state, OR)) %>% 
  ggplot(aes(x = city_state, y = OR)) + 
  geom_point() + 
  geom_errorbar(aes(ymin = CI_lower, ymax = CI_upper)) + 
  theme(axis.text.x = element_text(angle = 90, hjust = 1))
```
## Problem 2 
Load and clean data
```{r, message = FALSE}
birth_df = 
  read.csv("data/birthweight.csv") %>% 
  mutate(
    babysex = as.factor(babysex), 
    mrace = as.factor(mrace),
    malform = as.factor(malform),
    frace = as.factor(frace))
```

Check for missing values
```{r}
count_na =
birth_df %>%
  map_df(~sum(is.na(.)))
```

There are no NAs in `birth_df` 

### Building regression model

Chosen predictors 
- `ppwt` - mother's pre-pregnancy weight 
- `pnumblw` - previous number of low birth weight babies
- `wtgain` - mother's weight gain during pregnancy 
- `ppbmi` - mother's pre-pregnancy BMI 

Can we fit a linear regression model? Let's check visually. 

Pre-pregnancy weight of mother 
```{r}
ppwt_lin = 
  birth_df %>% 
  ggplot(aes(x = ppwt, y = bwt)) +
  geom_point()
ppwt_lin
```

Pre-pregnancy BMI 
```{r}
ppbmi_lin = 
birth_df %>% 
  ggplot(aes(x = ppbmi, y = bwt)) +
  geom_point()

ppbmi_lin
```

Mother's weight gain 
```{r}
wtgain_lin = 
birth_df %>% 
  ggplot(aes(x = wtgain, y = bwt)) +
  geom_point()

wtgain_lin
```

Previous low birthweight babies
```{r}
pnumlbw_lin = 
birth_df %>% 
  ggplot(aes(x = pnumlbw, y = bwt)) +
  geom_point()

pnumlbw_lin
```

I have decided not to include the `pnumlbw` variable in further analyses because as we can see from the plot above, all the values are 0, indicating that in this dataset, mothers did not have any babies with low birthweight babies. For the other 3 predictors, it seems like there may be some linear relationship so these will be included in the  final model. 

